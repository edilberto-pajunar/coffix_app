# name: Deploy API (Firebase Functions)

# on:
#   push:
#     branches:
#       - main
#       - dev
#     paths:
#       - "functions/**"
#       - "firebase.json"
#       - ".firebaserc"
#       - ".github/workflows/deploy-functions.yml"
#   workflow_dispatch:
#     inputs:
#       target:
#         description: "Where to deploy the API"
#         required: true
#         type: choice
#         options:
#           - dev
#           - prod

# permissions:
#   contents: read

# concurrency:
#   group: deploy-functions-${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.target || 'auto' }}
#   cancel-in-progress: false

# jobs:
#   deploy_dev:
#     name: Deploy (dev)
#     if: (github.event_name == 'push' && github.ref == 'refs/heads/dev') || (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'dev')
#     runs-on: ubuntu-latest
#     environment: dev
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-node@v4
#         with:
#           node-version: 24
#           cache: npm
#           cache-dependency-path: functions/package-lock.json

#       - name: Install dependencies
#         run: npm ci --prefix functions

#       - name: Install Firebase CLI
#         run: npm i -g firebase-tools

#       - name: Write dev .env
#         env:
#           FUNCTIONS_ENV: ${{ secrets.FUNCTIONS_ENV_DEV }}
#         run: |
#           printf '%s' "$FUNCTIONS_ENV" > functions/.env

#       - name: Write dev service account key
#         env:
#           FIREBASE_SA: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
#         run: |
#           printf '%s' "$FIREBASE_SA" > "$RUNNER_TEMP/firebase-sa.json"
#           echo "GOOGLE_APPLICATION_CREDENTIALS=$RUNNER_TEMP/firebase-sa.json" >> "$GITHUB_ENV"

#       - name: Deploy functions to dev
#         env:
#           CLOUDSDK_CORE_DISABLE_PROMPTS: "1"
#         run: firebase deploy --only functions --project coffix-app-dev --non-interactive

#   deploy_prod:
#     name: Deploy (prod)
#     if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'prod')
#     runs-on: ubuntu-latest
#     environment: prod
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-node@v4
#         with:
#           node-version: 24
#           cache: npm
#           cache-dependency-path: functions/package-lock.json

#       - name: Install dependencies
#         run: npm ci --prefix functions

#       - name: Install Firebase CLI
#         run: npm i -g firebase-tools

#       - name: Write prod .env
#         env:
#           FUNCTIONS_ENV: ${{ secrets.FUNCTIONS_ENV_PROD }}
#         run: |
#           printf '%s' "$FUNCTIONS_ENV" > functions/.env

#       - name: Write prod service account key
#         env:
#           FIREBASE_SA: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}
#         run: |
#           printf '%s' "$FIREBASE_SA" > "$RUNNER_TEMP/firebase-sa.json"
#           echo "GOOGLE_APPLICATION_CREDENTIALS=$RUNNER_TEMP/firebase-sa.json" >> "$GITHUB_ENV"

#       - name: Deploy functions to prod
#         env:
#           CLOUDSDK_CORE_DISABLE_PROMPTS: "1"
#         run: firebase deploy --only functions --project coffix-app-prod --non-interactive
